---
title: "Clase 2. Ejercicios de Práctica"
author: "Juan Barriola y Sofía Perini"
date: "12 de Septiembre de 2020"
output: 
  html_notebook: 
    toc: true
    toc_float: true
    depth: 2
---

# Ejercicios Clase 2

## Ejercicio 1: Precios y dólar

En la carpeta __Fuentes__ se encuentran los archivos __dolar_oficial_ambito.csv__ y __ipc-mensual.xlsx__. Con ellos, el objetivo es realizar un análisis exploratorio de estas variables de la economía argentina. La base de datos del dolar tiene frecuencia diaria y comienza en Marzo de 2002. La base de datos del IPC tiene frecuencia mensual y comienza en Diciembre de 2016.


### Dólar

1. Leer el dataset
2. Crear la variable cotización_promedio, realizando el promedio entre compra y venta para cada día
3. Graficar la evolución diaria de la cotización promedio
4. Crear las variables fecha, año, mes y día 
5. Calcular la mediana de la cotización promedio para cada año y mes (esta será la cotización mensual del dólar oficial)
6. Graficar la evolución del tipo de cambio por mes

### IPC

1. Leer el dataset 
2. Modificar el dataset para que cumpla con la definición de tidy data: cada variable debe ser una columna (Apertura, Fecha e Indice). *Pista*: piensen si tienen que usar $spread$ o $gather$
3. Crear las variables fecha, año, mes y día 
4. Graficar la evolución del nivel general del IPC
5. Graficar la evolución de los 4 grupos

### IPC y Dolar 

1. Realizar un join de ambos conjuntos de datos (dólar mensual e IPC) de manera que queden los meses para los cuáles hay datos de ambas variables 
2. Calcular la media, el desvío estándar, la mediana y el rango del dólar y del IPC General para cada uno de los años
3. Graficar la evolución del dólar y del nivel general del IPC (tener en cuenta el rango de las variables)
4. Graficar la evolución del dólar y de los 4 grupos de IPC

## Ejercicio 2: Trabajo con strings

Vamos a ver un ejemplo a partir de una base pública que nos trae información sobre ataques de tiburones en el mundo en distintos momentos. Cada fila corresponde a un ataque.

```{r}
tiburones <- read.csv("https://raw.githubusercontent.com/dmuba/dmuba.github.io/3005a7a5e8c9db5c188ca22a7b9269c94db8ced7/Practicos/TPs%20Entregables/TP02/Shark_Attack_Data.csv") %>% 
  select(-c(Case.Number.1, Case.Number.2, original.order, X, X.1))
```

Vamos a trabajar un poco con la limpieza y la normalización de esta base ya que al juntar datos de distintas fuentes la información no es homogénea por lo que es dificil hacer cualquier tipo de análisis.

Analicemos la variable del país (*Country*)

```{r}
# Creamos una lista con los valores de Country para ver si hay algunos problemas
tiburones %>% 
  select(Country) %>% # Seleccionamos la variable del pais
  mutate(Country = as.character(Country)) %>% # Lo convertimos de factor a string
  arrange(Country) %>% # La ordenamos
  distinct() %>% # Nos quedamos con los valores unicos
  as.list() # La convertimos en lista para que sea mas sencilla de ver
```
  
Hay varios problemas, pero veamos dos:

- Hay algunos nombres que no están en mayúscula
- Hay algunos nombres que tienen espacios en blanco a izquierda y derecha

Llevamos los nombres a mayúscula

```{r}
tiburones <- tiburones %>% 
  mutate(pais = str_to_upper(Country))
head(tiburones, 10)
```

Quitamos los espacios en blanco a izquierda y derecha

```{r}
tiburones <- tiburones %>% 
  mutate(pais = str_trim(pais, side = "both"))
tiburones %>% 
  select(pais) %>% # Seleccionamos la variable del pais
  arrange(pais) %>% # La ordenamos
  distinct() %>% # Nos quedamos con los valores unicos
  as.list() # La convertimos en lista para que sea mas sencilla de ver
```

Analizando la variable **Date** de nuestro dataset. Primero llevamos esta variable a un pequeño dataset aparte y llevamos la variable al tipo character para poder manejarla como un string.

```{r}
Date <- tiburones %>% 
  select(Case.Number, Date) %>% # Seleccionamos variables numero caso y fecha
  mutate(Date = as.character(Date)) # Tranformamos la fecha en string
glimpse(Date)
head(Date,10)
```

Vemos que la variable Date viene en muchos casos con la palabra Reported lo cual nos impide que podamos tratar esa expresión como fecha usando las herramientas que vimos en la sección de lubridate.

```{r}
Date <- Date %>% 
  mutate(date_clean1 = str_replace_all(string = Date, pattern =  "Reported ", replacement = ""))
head(Date,10)
```

Vamos ahora a ver el caso de la variable **Time**. Vamos a proceder igual que con la variable Date, creando un pequeño dataset para normalizar esta variable.

```{r}
#traemos la variable que nos interesa
Time <- tiburones %>% 
  select(Time) %>%
  # la llevamos a tipo character para trabajarla como string
  mutate(Time = as.character(Time))
# borro esta entrada porque tiene un dato raro que no nos deja trabajar 
Time[1545,] <- ""
# llevamos todo a minúsculas (con otra función que también hace eso)
Time <- Time %>% 
  mutate(Time = tolower(Time))
Time
```

Nuestro objetivo es llevar las horas a una variable categórica con los valores mañana, tarde y noche. Para eso por un lado vamos a tener que extraer la hora de las variables que la tienen cargada en forma númerica para luego agruparlas en esas tres categorías, y por el otro lado normalizar la forma categórica dada en inglés que actualmente tiene cuatro categorías.

Empecemos trabajando con las entradas que tienen los valores dados en números. Primero vamos a ver que entradas tienen h y vamos a generar una columna con el largo del string.

```{r}
Time <- Time %>% 
  mutate(tiene_h = grepl(pattern = "h",x = Time),
         largo = str_length(Time))
Time
```

Ahora creamos una variable que nos va a decir si se trata de un caso con la hora dada en números. Para detectar estos casos, el string tiene que contener la letra h y tener 5 caracteres.

```{r}
Time = Time %>% 
  mutate(es_hora = case_when(tiene_h == TRUE & largo == 5 ~ "si",
                             tiene_h == FALSE | largo != 5 ~ "no"))
Time
```

Ahora, si se trata de una entrada con el formato de hora, vamos a traer la primera y segunda posición que corresponden a la hora.

```{r}
Time = Time %>% mutate(hora = case_when(es_hora == "si" ~ substr(Time,1,2)),
                       hora = as.numeric(hora))
Time
```

Ahora vamos a llevar los valores numéricos continuos a las variables discretas que mencionamos y vamos a llevar las variables en inglés a las variables en castellano.

```{r}
Time = Time %>% 
  mutate(hora_estandar = case_when(grepl("afternoon",Time) == TRUE ~ "tarde",
                                         grepl("day",Time) == TRUE ~ "tarde",
                                         grepl("night",Time)==TRUE ~ "noche",
                                         grepl("morning",Time)==TRUE~"mañana",
                                         hora > 5 & hora < 12     ~ "mañana",
                                         hora > 11 & hora < 19    ~ "tarde",
                                         hora < 6 | hora > 18     ~ "noche"))
# Reemplazamos los NA por "hora indefinida" 
Time <- Time %>% replace_na(list(hora_estandar="hora indefinida"))
Time
```

Fecha con Lubridate

```{r}
# Seleccionamos algunas variables
tiburones <- tiburones %>% 
  select(Case.Number, Type,Date, pais)
# Hacemos la limpieza de la fecha como vimos más arriba
tiburones <- tiburones %>% 
  mutate(date_clean1 = str_replace_all(string = Date, 
                                       pattern =  "Reported ", 
                                       replacement = ""))
glimpse(tiburones)
```

Transformamos la variable fecha de un string a una fecha

```{r}
tiburones <- tiburones %>% mutate(fecha= dmy(date_clean1))
```

El mensaje indica que no pudo convertir a fecha 887 registros.

Extraemos variables de la fecha
```{r}
tiburones <- tiburones %>% 
  mutate(año = year(fecha), # Obtener el año
         semestre = semester(fecha), # Obtener el semestre
         trimestre = quarter(fecha),# Obtener el trimestre 
         mes = month(fecha,label = TRUE), # Obtener el nombre del mes
         dia = day(fecha),# Obtener el día
         dia_semana = wday(fecha, label = TRUE)) # Obtener el nombre del día
glimpse(tiburones)
```

## Ejercicio 3: EPH (OPCIONAL)

El Objetivo de estos ejercicios es practicar el uso del $tidyverse$ para la manipulación de los datos, y $ggplot$ para graficar la información. En las consignas, se propone de manera general qué variables se quiere observar. Ustedes deberán levantar y procesar los datos de la Encuesta Permanente de Hogares, y gráficarlos como consideren que mejor se aprecia la relación entre las variables.     

Una __ayuda__ es utilizar el [diseño de registro](../Fuentes/EPH_registro_2_trim_2016.pdf) para codificar las variables

  
__ejercicios__

- Graficar la distribución del ingreso por ocupación principal (p21) según categoría ocupacional (CAT_OCUP). (opcional: utilizar la librería [ggridges](https://cran.r-project.org/web/packages/ggridges/vignettes/introduction.html))

- Incorporar en el gráfico anterior la condición de precariedad laboral (PP07H).

- Quedarse sólo con los asalariados (CAT_OCUP = 3), y graficar la relación entre ingreso por ocupación principal(p21), precariedad laboral (PP07H) y tamaño del establecimiento(PP04C99).

- Quedarse con los Cuentapropistas y asalariados (CAT_OCUP = 2 y 3) y comparar, según la condición de precariedad laboral (PP07H) la distribución del ingreso según sexo (CH04)

- Incorporar en el gráfico anterior el tamaño del establecimiento(PP04C99)


__yapa:__ Si quisieramos modelar la probabilidad de un evento podemos usar una regresión logísitca (en ggplot ```stat_smooth(method="glm", method.args=list(family="binomial")```).     
Utilicen este modelo para hacer un gráfico que eche luz sobre el siguiente fenómeno: 

- ¿Cómo se distribuye la probabilidad de querer trabajar más horas (PP03G) según el total de horas trabajadas por semana (PP3E_TOT)? ¿Es diferente el modelo según sexo(CH04)?