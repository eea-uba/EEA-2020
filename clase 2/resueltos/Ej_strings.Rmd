---
title: "Ejercicio 2: Strings"
output: html_notebook
---

Vamos a ver un ejemplo a partir de una base pública que nos trae información sobre ataques de tiburones en el mundo en distintos momentos. Cada fila corresponde a un ataque.


```{r}
library(tidyverse)
```


```{r}
tiburones <- read_csv("https://raw.githubusercontent.com/dmuba/dmuba.github.io/3005a7a5e8c9db5c188ca22a7b9269c94db8ced7/Practicos/TPs%20Entregables/TP02/Shark_Attack_Data.csv") %>% 
  select(-c(Case.Number.1, Case.Number.2, original.order, X, X.1))
```

Vamos a trabajar un poco con la limpieza y la normalización de esta base ya que al juntar datos de distintas fuentes la información no es homogénea por lo que es dificil hacer cualquier tipo de análisis.

Analicemos la variable del país (*Country*)

```{r}
# Creamos una lista con los valores de Country para ver si hay algunos problemas
tiburones %>% 
  select(Country) %>% # Seleccionamos la variable del pais
  mutate(Country = as.character(Country)) %>% # Lo convertimos de factor a string
  arrange(Country) %>% # La ordenamos
  distinct() %>% # Nos quedamos con los valores unicos
  as.list() # La convertimos en lista para que sea mas sencilla de ver
```
  
Hay varios problemas, pero veamos dos:

- Hay algunos nombres que no están en mayúscula
- Hay algunos nombres que tienen espacios en blanco a izquierda y derecha

Llevamos los nombres a mayúscula

```{r}
tiburones <- tiburones %>% 
  mutate(pais = str_to_upper(Country))
head(tiburones, 10)
```

Quitamos los espacios en blanco a izquierda y derecha

```{r}
tiburones <- tiburones %>% 
  mutate(pais = str_trim(pais, side = "both"))
tiburones %>% 
  select(pais) %>% # Seleccionamos la variable del pais
  arrange(pais) %>% # La ordenamos
  distinct() %>% # Nos quedamos con los valores unicos
  as.list() # La convertimos en lista para que sea mas sencilla de ver
```

Analizando la variable **Date** de nuestro dataset. Primero llevamos esta variable a un pequeño dataset aparte y llevamos la variable al tipo character para poder manejarla como un string.

```{r}
Date <- tiburones %>% 
  select(Case.Number, Date) %>% # Seleccionamos variables numero caso y fecha
  mutate(Date = as.character(Date)) # Tranformamos la fecha en string
glimpse(Date)
head(Date,10)
```

Vemos que la variable Date viene en muchos casos con la palabra Reported lo cual nos impide que podamos tratar esa expresión como fecha usando las herramientas que vimos en la sección de lubridate.

```{r}
Date <- Date %>% 
  mutate(date_clean1 = str_replace_all(string = Date, pattern =  "Reported ", replacement = ""))
head(Date,10)
```

Vamos ahora a ver el caso de la variable **Time**. Vamos a proceder igual que con la variable Date, creando un pequeño dataset para normalizar esta variable.

```{r}
#traemos la variable que nos interesa
Time <- tiburones %>% 
  select(Time) %>%
  # la llevamos a tipo character para trabajarla como string
  mutate(Time = as.character(Time))
# borro esta entrada porque tiene un dato raro que no nos deja trabajar 
Time[1545,] <- ""
# llevamos todo a minúsculas (con otra función que también hace eso)
Time <- Time %>% 
  mutate(Time = tolower(Time))
Time
```

Nuestro objetivo es llevar las horas a una variable categórica con los valores mañana, tarde y noche. Para eso por un lado vamos a tener que extraer la hora de las variables que la tienen cargada en forma númerica para luego agruparlas en esas tres categorías, y por el otro lado normalizar la forma categórica dada en inglés que actualmente tiene cuatro categorías.

Empecemos trabajando con las entradas que tienen los valores dados en números. Primero vamos a ver que entradas tienen h y vamos a generar una columna con el largo del string.

```{r}
Time <- Time %>% 
  mutate(tiene_h = grepl(pattern = "h",x = Time),
         largo = str_length(Time))
Time
```

Ahora creamos una variable que nos va a decir si se trata de un caso con la hora dada en números. Para detectar estos casos, el string tiene que contener la letra h y tener 5 caracteres.

```{r}
Time = Time %>% 
  mutate(es_hora = case_when(tiene_h == TRUE & largo == 5 ~ "si",
                             tiene_h == FALSE | largo != 5 ~ "no"))
Time
```

Ahora, si se trata de una entrada con el formato de hora, vamos a traer la primera y segunda posición que corresponden a la hora.

```{r}
Time = Time %>% mutate(hora = case_when(es_hora == "si" ~ substr(Time,1,2)),
                       hora = as.numeric(hora))
Time
```

Ahora vamos a llevar los valores numéricos continuos a las variables discretas que mencionamos y vamos a llevar las variables en inglés a las variables en castellano.

```{r}
Time = Time %>% 
  mutate(hora_estandar = case_when(grepl("afternoon",Time) == TRUE ~ "tarde",
                                         grepl("day",Time) == TRUE ~ "tarde",
                                         grepl("night",Time)==TRUE ~ "noche",
                                         grepl("morning",Time)==TRUE~"mañana",
                                         hora > 5 & hora < 12     ~ "mañana",
                                         hora > 11 & hora < 19    ~ "tarde",
                                         hora < 6 | hora > 18     ~ "noche"))
# Reemplazamos los NA por "hora indefinida" 
Time <- Time %>% replace_na(list(hora_estandar="hora indefinida"))
Time
```

Fecha con Lubridate

```{r}
# Seleccionamos algunas variables
tiburones <- tiburones %>% 
  select(Case.Number, Type,Date, pais)
# Hacemos la limpieza de la fecha como vimos más arriba
tiburones <- tiburones %>% 
  mutate(date_clean1 = str_replace_all(string = Date, 
                                       pattern =  "Reported ", 
                                       replacement = ""))
glimpse(tiburones)
```

Transformamos la variable fecha de un string a una fecha

```{r}
tiburones <- tiburones %>% mutate(fecha= dmy(date_clean1))
```

El mensaje indica que no pudo convertir a fecha 887 registros.

Extraemos variables de la fecha
```{r}
tiburones <- tiburones %>% 
  mutate(año = year(fecha), # Obtener el año
         semestre = semester(fecha), # Obtener el semestre
         trimestre = quarter(fecha),# Obtener el trimestre 
         mes = month(fecha,label = TRUE), # Obtener el nombre del mes
         dia = day(fecha),# Obtener el día
         dia_semana = wday(fecha, label = TRUE)) # Obtener el nombre del día
glimpse(tiburones)
```