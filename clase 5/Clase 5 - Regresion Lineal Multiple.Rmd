---
title: "Regresión Lineal Múltiple"
author: "Juan Barriola y Sofía Perini"
date: "3 de Octubre de 2020"
output:
  html_notebook:
    theme: spacelab
    toc: yes
    toc_float: yes
    df_print: paged
---

# Encuesta de Sueldos en el sector IT

Vamos a trabajar con el subconjunto de datos que surgió del trabajo de limpieza que se hizo en la clase de regresión lineal simple, correspondiente al grupo de salarios de los data scientists/analyst. 

```{r, warning=F}
library(data.table)
library(tidyverse)
library(readxl) 
```

## Levantamos Dataset

```{r}
encuesta <- read_csv("../Fuentes/encuesta_sueldos_sysarmy_1s2020.csv")
encuesta %>%
  head()
```

### Limpieza de datos: Aplicamos Filtros

```{r}
encuesta_ds <- encuesta %>%
  filter(trabajo_de %in% c("Data Scientist / Data Engineer", "BI Analyst / Data Analyst")) %>%
  rename(edad = tengo, 
         salario_bruto = salario_mensual_bruto_en_tu_moneda_local,
         salario_neto = salario_mensual_neto_en_tu_moneda_local)
edad_laboral_minima = 14
limite_inferior_percentil = 20962.50 # percentil 0.05 sueldo_neto
limite_superior_outliers = 137000 # Q3 + 1.5 IQR sueldo_neto
df <- encuesta_ds %>% 
  filter(between(salario_neto, limite_inferior_percentil, limite_superior_outliers), # eliminamos los outliers de acuerdo a los criterios de la clase 3
        sueldo_dolarizado == 0, #Eliminamos los sueldos dolarizados 
        edad - anos_de_experiencia > edad_laboral_minima, # Eliminamos registros inconsistentes con la edad laboral
        salario_bruto > salario_neto, # Inconsistencia en los sueldos
        anos_en_la_empresa_actual < 70, # Error de carga
        me_identifico != "Otros") %>%  # elimnamos la categoria otros de me_identifico porque solo tiene 2 valores
  select(-sueldo_dolarizado) # Eliminamos la columna de sueldo dolarizado
df

```

### Seleccionamos variables de interés

```{r}
df <- df %>%
  select(me_identifico, edad, donde_estas_trabajando, anos_de_experiencia, anos_en_la_empresa_actual, anos_en_el_puesto_actual, gente_a_cargo, trabajo_de, nivel_de_estudios_alcanzado, estado, salario_bruto, salario_neto) 
df %>%
  head()
```
## Partición del dataset en train y test

Realizamos una partición entre dataset de entrenamiento (70%) y testeo (30%) usando la función resample_partition del paquete modelr.

```{r}
# fijo semilla
set.seed(44)
# Partición Train y Test
train_test <- df %>% 
  modelr::resample_partition(c(train = 0.7, test = 0.3))

df_train <- train_test$train %>% as_tibble()
df_test <- train_test$test %>% as_tibble()

# veo el contenido
df_train %>%
  glimpse() # 170 filas
df_test %>%
  glimpse() # 74 filas
```

### Modelo Lineal Múltiple

El modelo de regresión lineal múltiple es un modelo para la variable aleatoria Y cuando se conocen las variables regresoras. Es múltiple ya que vincula una serie de variables predictoras con Y. 

El modelo en términos de las variables:

$$Y_i = β_0 + β_1X_{i1} + β_2X_{i2} + · · · + β_{p-1}X_{ip-1} + ε_i$$
donde $β_0$, $β_1$,.., $β_{p−1}$ son parámetros desconocidos, $X_{i1}$, $X_{i2}$, ..., $X_{ip-1}$ son los valores de las variables predictoras medidas en el i-ésimo individuo, $Y_i$ es la variable respuesta medida en el i-ésimo individuo (observado) y $ε_i$ es el error para el individuo i-ésimo (no observable).

Supuestos del modelo lineal
Se pueden resumir como ϵi ~ N(0,σ2) 1<i<n, independientes entre sí.

El modelo en términos de la esperanza condicional de Y dadas $X_1$, $X_2$,..., $X_{p-1}$:

$$E(Y|X_1,X_2,...X_{p-1}) = β_0 + β_1X_{i1} + β_2X_{i2} + · · · + β_{p-1}X_{ip-1}$$

El modelo se denomina *lineal* puesto que la esperanza de Y condicional a las X's depende linealmente de las covariables $X_1$, $X_2$,..., $X_{p-1}$. 

### Ajuste del Modelo

Se quiere ajustar un modelo para el salario neto en función de distintas variables:

$$salarioNeto = \beta_0 + \beta_1x_i1 + \beta_2x_i2 + \epsilon_i$$
#### 1) Predictores numéricos

Armemos un modelo para predecir el salario_neto en función de los años de experiencia y la edad.

```{r}
# ajustamos modelo lineal multiple
lm1 <- lm(salario_neto ~ anos_de_experiencia + edad, data = df_train)
# Resumen del modelo
summary(lm1)
```

##### Significado de los coeficientes estimados

* El valor de la ordenada al origen (36.694) es el valor de salario neto esperado para alguien sin experiencia laboral (0 años de experiencia) y con edad 0, por lo que no tendría sentido. 

* El coeficiente estimado de años de experiencia (1.156) no es el mismo que cuando los años de experiencia eran la única variable que explicaba el modelo (modelo simple), su valor descendió de 1.676 a 1.156. Esto implica que, si mantenemos la edad constante, cada incremento de un año en los años de experiencia corresponde a un aumento de 1.156 pesos en el sueldo neto, en promedio. O lo que es igual, dadas dos personas con la misma edad pero teniendo uno un año más de experiencia que el otro, el sueldo neto esperado para el de mayor experiencia será 1.156 pesos más alto que el de menor experiencia.

¿Cómo se interpretaría el coeficiente estimado de la edad?

#### 2) Predictores Categóricos

##### **Ppredictor binario**:

Armemos un modelo para predecir el salario_neto en función de los años de experiencia, la edad y género (me_identifico). Introducimos la variable lugar de trabajo que es categórica. Veamos qué ocurre:

```{r}
lm2 <- lm(salario_neto ~ anos_de_experiencia + me_identifico, data = df_train)
summary(lm2)
```

¿Cómo se interpretan los coeficientes de la variable dicotómica?

Vemos que el nivel medio del sueldo neto es una función lineal de los años de experiencia de la persona, con una misma pendiente β1 para mujeres y hombres. Por otro lado, β2 indica cuánto más baja es la función de respuesta para las mujeres respecto de los hombres (categoría basal), dados los años de experiencia.

El modelo de regresión lineal en este caso consiste simplemente en expresar
la media del nivel de sueldo neto en cada población (de hombres y mujeres) mediante dos coeficientes distintos, donde β0 es la media del sueldo neto para los hombres y β0+β2 es la media del salario neto para las mujeres, dados los años de experiencia. Por lo tanto, β2 es la diferencia (en este caso negativa) en los niveles medios de salario neto de los hombres respecto de las mujeres.

#### **Predictores Cualitativos con más de dos clases**

Como hay dos variables que se refieren al nivel de estudios alcanzado, vamos a unificar en una misma y reagrupar los datos.

```{r}
unique(df$nivel_de_estudios_alcanzado)
df2 <- df_train %>% 
  mutate(nivel_educativo = case_when(nivel_de_estudios_alcanzado %in% c("Posgrado", "Posdoctorado", "Doctorado") ~ "Posgrado", 
                                     TRUE ~ nivel_de_estudios_alcanzado))
# unificamos nivel educativo y estado 
df2 <- df2 %>% 
  mutate(nivel_edu_alcanzado = paste(nivel_educativo, sep = " ", estado))
sort(unique(df2$nivel_edu_alcanzado)) # quedan 9 categorías
```

Probemos armar un modelo lineal para el sueldo neto en función de los años de experiencia y esta nueva variable de nivel_edu_alcanzado.  

```{r}
lm3 <- lm(salario_neto ~ anos_de_experiencia + nivel_edu_alcanzado, data = df2)
summary(lm3)
```
¿Mejoró el modelo incorporando esta nueva variable? Sí. 

¿Qué significan los coeficientes de la nueva variable categórica?

Este modelo propone ajustar una recta distinta para el sueldo neto medio
de cada grupo de personas definido por el nivel educativo alcanzado, todas con igual pendiente (definida por los años de experiencia), y nueve ordenadas al origen diferentes, una por cada grupo (nivel educativo alcanzado).

Por ejemplo, β2 = nivel_edu_alcanzado Posgrado En curso, indica cuánto se reduce el sueldo neto medio para las personas cuyo nivel educativo es Posgrado En curso respecto de aquellas cuyo nivel es Posgrado Completado, dados los años de experiencia.

#### Significatividad de las variables 
