---
title: "Regresión Lineal Simple"
author: "Juan Barriola y Sofía Perini"
date: "19 de Septiembre de 2020"
output:
  html_notebook:
    theme: spacelab
    toc: yes
    toc_float: yes
    df_print: paged
---

# Encuesta de Sueldos en el sector IT

Vamos a trabajar con un dataset de openqube^[https://openqube.io/encuesta-sueldos-2020.01#Introduccion%20%20%20https://docs.google.com/spreadsheets/d/e/2PACX-1vTORpz5hc_wOwKdaKEIgVOAI3XVTh9WXB__C2abe_E0aJoYIoqhWQ-HTpBBryAByhIlX_booioqxK0T/pub?gid=1893349211&single=true&output=csv] sobre empleos en el sector IT.

```{r}
library(data.table)
library(tidyverse)
library(readxl)
encuesta <- read_csv("../Fuentes/Encuesta de remuneracion salarial - 2020.1.csv")
encuesta %>%
  glimpse()
encuesta %>%
  head(10)

unique(encuesta$`Estoy trabajando en`) # solo Argentina aparece
unique(encuesta$`Dónde estás trabajando`) # en qué parte del país
unique(encuesta$`Trabajo de`)
table(encuesta$`Trabajo de`)
# unique(encuesta$Carrera)
```

### Filtros 

Se filtran las variables de interes.

```{r}
df1 <- encuesta[,c(1:5,24:31,35,47:49)]

library(lubridate)
class(df1$Timestamp)
ymd_hms(df1$Timestamp) # no se convierten a timestamp

```

Aplicar filtros: 

- Donde estás trabajando: GBA y CABA. 
- Tipo de contrato = Full-Time

```{r}
df1 %>%
  summary()

df2 <- df1 %>%
  filter(`Tipo de contrato` == "Full-Time")

df2 %>%
  head(5)

dim(df2)

glimpse(df2)
```

### Chequeo valores unicos y faltantes 

```{r}
tabla2 <- df2 %>% gather(.,
                         key   = Variables,
                         value = Valores) %>% 
  group_by(Variables) %>% 
  summarise(Valores.unicos = length(unique(Valores)), Valores.faltantes = sum(is.na(Valores)))
# ordeno la tabla por valores faltantes y luego unicos.
tabla2 %>% arrange(Valores.faltantes, Valores.unicos)
```

### Chequeo Outliers Univariados

```{r}
df2[,c(3,6:9,16,17)] %>%
  gather(.,
         key = Variables, 
         value = Valores) %>% 
  ggplot(aes(x = Variables, y = as.numeric(Valores))) + 
  geom_boxplot(alpha = 0.5) + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap( ~ Variables, scales = "free")

# tratamiento de outliers
# corrijo datos porque entiendo se trata de un error de carga y hay información para contrastar el dato
df2$`Años en la empresa actual`[df2$`Años en la empresa actual` == 2016] <- 4
df2$`Años en la empresa actual`[df2$`Años en la empresa actual` == 88] <- 8

df2 <- df2 %>%
  mutate(`Salario mensual BRUTO (en tu moneda local)` = round(`Salario mensual BRUTO (en tu moneda local)`), `Salario mensual NETO (en tu moneda local)` = round(`Salario mensual NETO (en tu moneda local)`))


# parecen valores mal cargados (corridas las comas)
# corregir datos o eliminar para que no ensucien la base 
# ver los que tienen salario neto mayor al bruto (se trata de un error)
dim(df2 %>%
  filter(`Salario mensual BRUTO (en tu moneda local)` < `Salario mensual NETO (en tu moneda local)`) %>%
  mutate(dif = `Salario mensual NETO (en tu moneda local)` - `Salario mensual BRUTO (en tu moneda local)`)) # 125 observaciones con datos mal cargados 

# elimino las lineas erroneas por mal carga de sueldos y otro outlier
df3 <- df2 %>%
  filter(`Años en el puesto actual` < 8000, `Salario mensual BRUTO (en tu moneda local)` > `Salario mensual NETO (en tu moneda local)`)

# decidi corregir los datos en relación al salario neto 
df3$`Salario mensual BRUTO (en tu moneda local)`[df3$`Salario mensual BRUTO (en tu moneda local)` == 2140000] <- 214000
df3$`Salario mensual BRUTO (en tu moneda local)`[df3$`Salario mensual BRUTO (en tu moneda local)` == 7470084] <- 74700
df3$`Salario mensual BRUTO (en tu moneda local)`[df3$`Salario mensual BRUTO (en tu moneda local)` == 55008226] <- 55000
df3$`Salario mensual BRUTO (en tu moneda local)`[df3$`Salario mensual BRUTO (en tu moneda local)` == 3130025] <- 31300
df3$`Salario mensual BRUTO (en tu moneda local)`[df3$`Salario mensual BRUTO (en tu moneda local)` == 1500000] <- 150000
df3$`Salario mensual BRUTO (en tu moneda local)`[df3$`Salario mensual BRUTO (en tu moneda local)` == 1250000] <- 125000
df3$`Salario mensual BRUTO (en tu moneda local)`[df3$`Salario mensual BRUTO (en tu moneda local)` == 900000] <- 90000
df3$`Salario mensual BRUTO (en tu moneda local)`[df3$`Salario mensual BRUTO (en tu moneda local)` == 900007] <- 90000
df3$`Salario mensual BRUTO (en tu moneda local)`[df3$`Salario mensual BRUTO (en tu moneda local)` == 700000] <- 70000
df3$`Salario mensual BRUTO (en tu moneda local)`[df3$`Salario mensual BRUTO (en tu moneda local)` == 580000] <- 58000

df3[,c(3,6:9,16:17)] %>%
  gather(.,
         key = Variables, 
         value = Valores) %>% 
  ggplot(aes(x = Variables, y = as.numeric(Valores))) + 
  geom_boxplot(alpha = 0.5) + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap( ~ Variables, scales = "free")

# chequeo outliers en variable salario bruto
df3 %>%
  filter(`Salario mensual BRUTO (en tu moneda local)` >= 500000)

# chequeo outliers en variable salario neto
df3 %>%
  filter(`Salario mensual BRUTO (en tu moneda local)` < 1000)

df3 <- df3 %>%
  mutate(salario_bruto = 
           case_when(`Salario mensual BRUTO (en tu moneda local)` < 1000 &
                       `Salario mensual NETO (en tu moneda local)` < 1000 ~ 
                       `Salario mensual BRUTO (en tu moneda local)`*1000, 
                     TRUE ~ `Salario mensual BRUTO (en tu moneda local)`), 
         salario_neto =           
           case_when(`Salario mensual BRUTO (en tu moneda local)` < 1000 &
                       `Salario mensual NETO (en tu moneda local)` < 1000 ~ 
                       `Salario mensual NETO (en tu moneda local)`*1000, 
                     TRUE ~ `Salario mensual NETO (en tu moneda local)`))

df3 <- df3 %>%
  mutate(salario_neto =           
           case_when(salario_neto < 1000 ~ salario_neto * 1000, 
                     TRUE ~ salario_neto))

# elimino dos registros erroneos
df3 <- df3 %>% 
  filter(salario_neto < salario_bruto)

df3 %>%
  mutate(dif = salario_neto - salario_bruto) %>%
  filter(dif < -100000, salario_neto < 100000) %>%
  select(Timestamp)

df3 %>%
  filter(salario_neto < 1000)

df3 %>%
  filter(salario_bruto > 1000000)

df3[,c(3,6:9,18:19)] %>%
  gather(.,
         key = Variables, 
         value = Valores) %>% 
  ggplot(aes(x = Variables, y = as.numeric(Valores))) + 
  geom_boxplot(alpha = 0.5) + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +
  facet_wrap( ~ Variables, scales = "free")

df3[df3$Timestamp == "1/8/2020 4:11:53","salario_bruto"] <- 45000
```

### Chequeo correlación

```{r}
library(corrr)
library(knitr)
library(kableExtra)
library(GGally)

# calculo matriz de correlacion para los registros completos (omitiendo faltantes) para variables numéricas con ambos métodos 

# pearson
matriz.correl.pe <- df3[,c(3,6:9,18:19)] %>% 
 correlate(use = "complete.obs", method = "pearson") %>% 
  shave() %>% 
  fashion()
matriz.correl.pe

# spearman
matriz.correl.sp <- df3[,c(3,6:9,18:19)] %>% 
 correlate(use = "complete.obs", method = "spearman") 
matriz.correl.sp

df3[,c(3,6:9,18:19)] %>%
     ggpairs(.,  mapping = aes(colour = df3$Estado),
        title = "Matriz de correlaciones")
        
```

```{r}
df3 %>%
  ggplot(aes(y = salario_neto, x = salario_bruto)) + 
  geom_point()
bdims %>% 
  ggplot(aes(x = wgt/1000, y = hip_gi, col = sex)) + 
  geom_point()
```



```{r}
data_anal <- df3 %>%
  filter(grepl("Anal", `Trabajo de`)) %>% 
  filter(`Tipo de contrato` == "Full-Time")

data_anal %>%
  glimpse()
  
lm(`Salario mensual NETO (en tu moneda local)` ~ `Años de experiencia`, data_anal) %>%
  summary()

ggplot(data_anal, aes(x = `Años de experiencia`, y = `Salario mensual NETO (en tu moneda local)`)) + 
  geom_point() +
  stat_smooth(method = "lm", col = "red")

```

