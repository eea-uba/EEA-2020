---
title: "Regresión Lineal Simple: Prueba"
author: "Juan Barriola y Sofía Perini"
date: "19 de Septiembre de 2020"
output:
  html_notebook:
    theme: spacelab
    toc: yes
    toc_float: yes
    df_print: paged
---

# Encuesta de Sueldos en el sector IT

Vamos a trabajar con un dataset de openqube^[https://openqube.io/encuesta-sueldos-2020.01#Introduccion%20%20%20https://docs.google.com/spreadsheets/d/e/2PACX-1vTORpz5hc_wOwKdaKEIgVOAI3XVTh9WXB__C2abe_E0aJoYIoqhWQ-HTpBBryAByhIlX_booioqxK0T/pub?gid=1893349211&single=true&output=csv] sobre empleos en el sector IT.

```{r}
library(data.table)
library(tidyverse)
library(readxl) 
library(lubridate)
library(corrr)
library(knitr)
library(kableExtra)
library(GGally)
```

## Preparación de Datos

```{r}
encuesta <- read_csv("../Fuentes/encuesta_sueldos_sysarmy_1s2020.csv")
encuesta %>%
  glimpse()
```

```{r}
colnames(encuesta_ds)
```


```{r}
me_identifico, tengo, anos_de_experiencia, anos_en_la_empresa_actual, anos_en_el_puesto_actual, gente_a_cargo, nivel_de_estudios_alcanzado, trabajo_de, salario_mensual_bruto_en_tu_moneda_local, salario_mensual_neto_en_tu_moneda_local, sueldo_dolarizado, orientacion_sexual
```


### Análisis exploratorio

```{r}
encuesta_ds = encuesta %>%
                filter(trabajo_de %in% c("Data Scientist / Data Engineer", "BI Analyst / Data Analyst"))
```


Chequeo valores unicos y faltantes. 

```{r}
tabla2=encuesta_ds %>%
  gather(., 
         key = "Variables", 
         value = "Valores") %>%
  group_by(Variables) %>% 
  summarise(Valores.unicos = length(unique(Valores)), Valores.faltantes = sum(is.na(Valores)))
# ordeno la tabla por valores faltantes y luego unicos.
tabla2 %>% 
  arrange(desc(Valores.faltantes), Valores.unicos)
```



### Filtros 

Se seleccionan las variables de interes.

```{r}
encuesta_ds_relevantes = encuesta_ds %>%
                              select(tengo, anos_de_experiencia, anos_en_la_empresa_actual, anos_en_el_puesto_actual,
                                     trabajo_de, salario_mensual_bruto_en_tu_moneda_local,
                                     salario_mensual_neto_en_tu_moneda_local, sueldo_dolarizado) %>% 
                              rename(edad = tengo,
                                     salario_bruto = salario_mensual_bruto_en_tu_moneda_local,
                                     salario_neto = salario_mensual_neto_en_tu_moneda_local)
```


Descripcion

```{r, message=FALSE, warning=FALSE}
encuesta_ds_relevantes %>% select(-sueldo_dolarizado) %>% ggpairs(aes(color=trabajo_de)) + 
  theme_bw()
```

## Limpieza de datos

### Limites del estudio

#### Sueldo dolarizado

Eliminar aquellas observaciones con el sueldo dolarizado para no incluir variaciones vinculadas al tipo de cambio en nuestro set de datos

```{r}
encuesta_ds_relevantes %>% filter(sueldo_dolarizado==1)
```


### Datos inconsistentes

Comencemos analizando aquellos registros que presentan datos que no son consistentes. 

#### Edad vs años de experiencia

Parecen existir algunos registros en los cuales la experiencia laboral supera la edad. 

```{r}
ggplot(encuesta_ds_relevantes, aes(x=edad, y=anos_de_experiencia, color=edad-anos_de_experiencia)) +
        geom_point() +
        theme_bw()
```

Sabiendo que la edad mínima para trabajar en Argentina es 14 años, podemos revisar en que registros la diferencia entre la edad y los años de experiencia es menor a dicho umbral.

```{r}
edad_laboral_minima = 14
encuesta_ds_relevantes %>% filter(edad-anos_de_experiencia<edad_laboral_minima)
```

**Caso particular: Años de experiencia en la empresa actual**

Hay un caso particular en el cual una persona contestó que lleva 2016 años en la empresa actual

```{r}
encuesta_ds_relevantes %>% filter(anos_en_la_empresa_actual>70)
```


### Salario neto superior al bruto

```{r}
ggplot(encuesta_ds_relevantes, aes(x=salario_mensual_bruto_en_tu_moneda_local, y=salario_mensual_neto_en_tu_moneda_local)) +
         geom_point() + theme_bw()
```


```{r}
encuesta_ds_relevantes %>% mutate(dif=(salario_mensual_bruto_en_tu_moneda_local-salario_mensual_neto_en_tu_moneda_local)/salario_mensual_bruto_en_tu_moneda_local) %>% arrange(desc(dif))
```


```{r}
encuesta_ds_relevantes %>% filter(salario_bruto<salario_neto)
```


```{r}
encuesta_ds_filtrada = encuesta_ds_relevantes %>%
                          filter(sueldo_dolarizado==0, #Eliminamos los sueldos dolarizados
                                 edad-anos_de_experiencia>edad_laboral_minima, # Eliminamos registros inconsistentes con la edad laboral
                                 salario_bruto>salario_neto, # Inconsistencia en los sueldos
                                 anos_en_la_empresa_actual<70) # Error de carga
```

```{r, message=FALSE, warning=FALSE}
encuesta_ds_filtrada %>% select(-sueldo_dolarizado) %>% ggpairs(aes(color=trabajo_de)) + 
  theme_bw()
```

### Chequeo Outliers Univariados

Chequeamos outliers del salario neto por mes.

Boxplot

```{r}
ggplot(encuesta_ds_filtrada, aes(y=salario_neto)) + geom_boxplot() + theme_bw()
```

```{r}
tabla_cuantiles <- function(x, q = c(0.25, 0.5, 0.75)) {
  tibble("{{ x }}" := quantile(x, q), "{{ x }}_q" := q)
}

vector_salario_neto = encuesta_ds_filtrada$salario_neto

tabla_cuantiles(vector_salario_neto, c(seq(0,1,0.05)))
```

```{r}
IQR(encuesta_ds_filtrada$salario_neto) * 1.5 + quantile(encuesta_ds_filtrada$salario_neto, 0.75)
```


```{r}
quantile(encuesta_ds_filtrada$salario_neto, 0.25) - IQR(encuesta_ds_filtrada$salario_neto) * 1.5  
```


```{r}
ggplot(encuesta_ds_filtrada, aes(x=trabajo_de, y=salario_neto, fill=trabajo_de)) + geom_boxplot() + theme_bw()
```


```{r}
encuesta_ds_final = encuesta_ds_filtrada %>% filter(between(salario_neto, 21350.00, 137000))
```

```{r}
ggplot(encuesta_ds_final, aes(x=trabajo_de, y=salario_neto, fill=trabajo_de)) + geom_boxplot() + theme_bw()
```

```{r, message=FALSE, warning=FALSE}
encuesta_ds_final %>% select(-sueldo_dolarizado) %>% ggpairs(aes(color=trabajo_de)) + 
  theme_bw()
```

### Chequeo correlación

```{r}


# calculo matriz de correlacion para los registros completos (omitiendo faltantes) para variables numéricas con ambos métodos 

# pearson
matriz.correl.pe <- encuesta_ds_final %>%
  select_if(is.numeric) %>% 
 correlate(use = "complete.obs", method = "pearson") %>% 
  shave() %>% 
  fashion()
matriz.correl.pe

# spearman
matriz.correl.sp <- encuesta_ds_final %>%
  select_if(is.numeric) %>% 
 correlate(use = "complete.obs", method = "spearman") 
matriz.correl.sp
```

```{r}
lm(salario_neto ~ edad, encuesta_ds_final) %>%
  summary()

encuesta_ds_final %>% filter(trabajo_de == ggplot(, aes(x = edad, y = salario_neto)) + 
  geom_point() +
  stat_smooth(method = "lm", col = "red")

```

```{r}
lm(salario_neto ~ edad + trabajo_de, encuesta_ds_final) %>%
  summary()
```

```{r}
data_anal <- df3 %>%
  filter(grepl("Anal", `Trabajo de`)) %>% 
  filter(`Tipo de contrato` == "Full-Time")

data_anal %>%
  glimpse()
  
lm(salario_bruto ~ `Años de experiencia`, data_anal) %>%
  summary()

ggplot(data_anal, aes(x = `Años de experiencia`, y = salario_bruto)) + 
  geom_point() +
  stat_smooth(method = "lm", col = "red")

```



```{r}
data_data <- df3 %>%
  filter(grepl("Data", `Trabajo de`))

data_data %>%
  glimpse()
  
lm(salario_bruto ~ `Años de experiencia`, data_data) %>%
  summary()

ggplot(data_data, aes(x = `Años de experiencia`, y = salario_bruto))+ 
  geom_point() +
  stat_smooth(method = "lm", col = "red")

```

```{r}
data_dev <- df3 %>%
  filter(grepl("Develop", `Trabajo de`))

data_dev %>%
  glimpse()

data_dev %>%
  summary()
  
lm(salario_bruto ~ `Años de experiencia`, data_dev) %>%
  summary()

ggplot(data_dev, aes(x = `Años de experiencia`, y = salario_bruto))+ 
  geom_point() +
  stat_smooth(method = "lm", col = "red")

# armo funciones para mostrar los datos resultantes de la regresión de forma tidy
fun1a <- function(porcion,grupo) { broom::tidy(lm(salario_bruto ~ `Años de experiencia`, data = porcion)) }
fun1b <- function(porcion,grupo) { broom::glance(lm(salario_bruto ~ `Años de experiencia`, data = porcion)) }
df_lm1 <- data_dev %>% 
  # Agrupo por tipo de propiedad
  group_by(Estado) %>%
  # Anidando
  nest() %>% 
  # Creo una columna que tenga el dataframe como resultado de la funcion
  mutate(lm1 = map(data, fun1a), glance1 = map(data, fun1b))

df_lm1 %>% 
  unnest(lm1, glance1)

# grafico recta ajustada por tipo de propiedad
ggplot(data_dev, aes(x = `Años de experiencia`, y = salario_bruto))+ 
  geom_point(alpha = 0.25) +
  stat_smooth(method = "lm", col = "red") +
  facet_wrap(~ Estado) + 
  labs(title = "") +
  theme(legend.position = 'none') 
```


```{r}
lm(salario_bruto ~ `Años de experiencia` + `Nivel de estudios alcanzado`, data_dev) %>%
  summary()

lm(salario_bruto ~ `Años de experiencia` + `Dónde estás trabajando` + `Nivel de estudios alcanzado`, data_dev) %>%
  summary()

lm(salario_bruto ~ `Años de experiencia` + `Dónde estás trabajando` + `¿Gente a cargo?` + `Nivel de estudios alcanzado`, data_dev) %>%
  summary()

ggplot(data_dev, aes(x = `Años de experiencia`, y = salario_bruto))+ 
  geom_point() +
  stat_smooth(method = "lm", col = "red")

```
