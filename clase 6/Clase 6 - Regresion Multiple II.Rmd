---
title: "Regresión Lineal Múltiple II"
author: "Juan Barriola y Sofía Perini"
date: "10 de Octubre de 2020"
output:
  html_notebook:
    theme: spacelab
    toc: yes
    toc_float: yes
    df_print: paged
---

<style type="text/css">
div.main-container {
  max-width: 1600px;
  margin-left: auto;
  margin-right: auto;
}
</style>


Después en la clase 6 daría ya con train/test.

1) medidas de evaluación  de R cuadrado ajustado
2) medidas de predicción
3) una discusión más general de explicación VS predicción

## Diagnóstico y Evaluación de Modelos de Regresión Lineal Múltiple

### Dataset 

Vamos a trabajar con el subconjunto de datos que surgió del trabajo de limpieza que se hizo en la clase de regresión lineal simple, correspondiente al grupo de salarios de los data scientists/analyst, de la encuesta de sueldos en el sector de tecnología en Argenina realizada por SysArmy. El informe, realizado por OpenQube lo pueden ver [acá](https://sueldos.openqube.io/encuesta-sueldos-2020.01/).

Nuestro objetivo es evaluar modelos de regresión lineal múltiple que buscan explicar el sueldo neto de Data Analysts, Data Scientists y Data Engineers en Argentina.

Es decir, evaluamos los siguientes modelos para el salario neto:

$salarioNeto = \beta_0 +\beta_1X_1+\beta_2X_2+...+\epsilon$

```{r, warning=F, message=F}
library(tidyverse)
library(tidymodels)
```

#### Levantamos Dataset y seleccionamos variables de interés

```{r}
encuesta <- read_csv("../Fuentes/encuesta_RLM_limpia.csv")
df <- encuesta %>%
  select(me_identifico, edad, donde_estas_trabajando, anos_de_experiencia, anos_en_la_empresa_actual, anos_en_el_puesto_actual, gente_a_cargo, trabajo_de, nivel_de_estudios_alcanzado, estado, salario_bruto, salario_neto) 
# agrego columna de nivel educativo alcanzado (agrupa nivel de estudios y estado)
df <- df %>% 
  mutate(nivel_educativo = case_when(nivel_de_estudios_alcanzado %in% c("Posgrado", "Posdoctorado", "Doctorado") ~ "Posgrado", 
                                     TRUE ~ nivel_de_estudios_alcanzado), nivel_edu_alcanzado = paste(nivel_educativo, sep = " ", estado))
df
```
### Partición del dataset en train y test

En este caso para evaluar los modelos vamos a realizar una partición entre dataset de entrenamiento (70%) y testeo (30%) usando la función resample_partition del paquete modelr.

```{r}
# fijamos semilla
set.seed(44)
# Partición Train y Test
train_test <- df %>% 
  modelr::resample_partition(c(train = 0.7, test = 0.3))
# armamos dataframe de testeo y entrenamiento
df_train <- train_test$train %>% as_tibble()
df_test <- train_test$test %>% as_tibble()
# vemos el contenido
df_train %>%
  glimpse() # 170 filas
df_test %>%
  glimpse() # 73 filas
```
Habíamos realizado tres modelos distintos para tratar de explicar el salario neto: 

* Modelo Años de experiencia y Edad

* Modelo Años de experiencia y Género

* Modelo Años de experiencia y Nivel Educativo Alcanzado

Volvemos a realizar estos modelos utilizando el dataset de entrenamiento:

```{r}
# Modelo Experiencia y Edad
modelo_exp_edad <- lm(salario_neto ~ anos_de_experiencia + edad, data = df_train)
# Modelo Experiencia y Género
modelo_exp_sex <- lm(salario_neto ~ anos_de_experiencia + me_identifico, data = df_train)
# Modelo Experiencia y Nivel Educativo
modelo_exp_edu <- lm(salario_neto ~ anos_de_experiencia + nivel_edu_alcanzado, data = df_train)
```

En el notebook previo sólo habíamos interpretado el valor de los parámetros estimados. Ahora buscaremos responder preguntas tales como:

¿La relación entre la variable dependiente e independiente es estadísticamente significativa?
¿Qué proporción de la variabilidad logra explicar el modelo? ¿Cómo decidir que modelo explica mejor el fenómeno?
¿El modelo cumple con los supuestos del modelo lineal?

## Evaluación del Modelo 

Utilizando el paquete broom, vamos a analizar las medidas de resumen del modelo y graficamos coeficientes estimados. 

```{r}
# medidas de resumen tidy (incluido el intervalo de confianza)
tidy_mes <- tidy(modelo_exp_sex, conf.int = TRUE)
tidy_mes
# Plot de los Coeficientes
ggplot(tidy_mes, aes(estimate, term, xmin = conf.low, xmax = conf.high, height = 0)) +
  geom_point(color = "forestgreen") +
  geom_vline(xintercept = 0, lty = 4, color = "black") +
  geom_errorbarh(color = "forestgreen") +
  theme_bw() +
  labs(y = "Coeficientes β", x = "Estimación")
glance(modelo_exp_sex)
```

```{r}
au_mes <- augment(modelo_exp_sex)
au_mes
```